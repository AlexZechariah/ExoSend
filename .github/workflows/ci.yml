name: ExoSend CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  BUILD_CONFIGURATION: Release
  FEED_URL: https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
  VCPKG_BINARY_SOURCES: 'clear;default,readwrite'

jobs:
  build-and-test:
    name: Build and Test (Windows)
    runs-on: windows-latest

    steps:
    # =========================================================================
    # Checkout Repository
    # =========================================================================
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # =========================================================================
    # Install Qt6 (pre-built MSVC 2022 x64 binaries - downloaded, not compiled)
    # =========================================================================
    - name: Install Qt6
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.8.3'
        arch: 'win64_msvc2022_64'
        cache: true

    # =========================================================================
    # Setup vcpkg
    # =========================================================================
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '39922dbab0cafd7a7150d459c6a181c7dee5dfbe'
        vcpkgJsonGlob: 'vcpkg.json'

    # =========================================================================
    # Cache vcpkg Dependencies
    # =========================================================================
    - name: Cache vcpkg Packages
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.VCPKG_ROOT }}/archives
          ${{ env.VCPKG_ROOT }}/downloads
          build/vcpkg_installed
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    # =========================================================================
    # Configure vcpkg GitHub Packages binary caching (NuGet)
    # =========================================================================
    - name: Configure vcpkg binary cache (NuGet)
      if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $ErrorActionPreference = 'Stop'

        $vcpkgExe = Join-Path $env:VCPKG_ROOT 'vcpkg.exe'
        if (-not (Test-Path $vcpkgExe)) {
          throw "vcpkg.exe not found at '$vcpkgExe'"
        }

        $nugetExe = & $vcpkgExe fetch nuget
        if (-not (Test-Path $nugetExe)) {
          throw "nuget.exe not found at '$nugetExe'"
        }
        if ([string]::IsNullOrWhiteSpace($env:GITHUB_TOKEN)) {
          throw "GITHUB_TOKEN is empty; cannot configure NuGet binary cache."
        }
        if ([string]::IsNullOrWhiteSpace($env:FEED_URL)) {
          throw "FEED_URL is empty; cannot configure NuGet binary cache."
        }

        $nugetConfigPath = Join-Path $env:RUNNER_TEMP 'vcpkg-nuget.config'
        $feedUrlEscaped = [System.Security.SecurityElement]::Escape($env:FEED_URL)
        $nugetConfigContent = @"
        <?xml version="1.0" encoding="utf-8"?>
        <configuration>
          <config>
            <add key="defaultPushSource" value="$feedUrlEscaped" />
          </config>
          <packageSources>
            <clear />
            <add key="GitHub" value="$feedUrlEscaped" />
          </packageSources>
          <packageSourceCredentials>
            <GitHub>
              <add key="Username" value="%GITHUB_ACTOR%" />
              <add key="ClearTextPassword" value="%GITHUB_TOKEN%" />
            </GitHub>
          </packageSourceCredentials>
          <apikeys>
            <add key="$feedUrlEscaped" value="%GITHUB_TOKEN%" />
          </apikeys>
        </configuration>
        "@
        [System.IO.File]::WriteAllText($nugetConfigPath, $nugetConfigContent, [System.Text.UTF8Encoding]::new($false))
        "VCPKG_NUGET_CONFIG_PATH=$nugetConfigPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

        $access = 'readwrite'
        if ($env:GITHUB_EVENT_NAME -eq 'pull_request') {
          $access = 'read'
        }

        # Enable NuGet binary caching for subsequent steps (keep local 'default' as fallback).
        "VCPKG_BINARY_SOURCES=clear;nugetconfig,$nugetConfigPath,$access;default,readwrite" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

    # =========================================================================
    # Locate VsDevCmd (MSVC + Windows SDK environment)
    # =========================================================================
    - name: Locate VsDevCmd
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'

        $vswhere = Join-Path ${env:ProgramFiles(x86)} 'Microsoft Visual Studio\Installer\vswhere.exe'
        if (-not (Test-Path $vswhere)) {
          throw "vswhere.exe not found at '$vswhere'"
        }

        $installPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
        if ([string]::IsNullOrWhiteSpace($installPath)) {
          throw "vswhere.exe did not return a Visual Studio installation path with VC tools."
        }

        $vsDevCmd = Join-Path $installPath 'Common7\Tools\VsDevCmd.bat'
        if (-not (Test-Path $vsDevCmd)) {
          throw "VsDevCmd.bat not found at expected path: $vsDevCmd"
        }

        "VSDEVCMD=$vsDevCmd" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

    # =========================================================================
    # Configure CMake
    # =========================================================================
    - name: Configure CMake
      shell: cmd
      run: |
        call "%VSDEVCMD%" -no_logo -arch=x64 -host_arch=x64
        set CC=cl
        set CXX=cl
        cmake --preset windows

    # =========================================================================
    # Validate Resolved Compiler/Toolchain
    # =========================================================================
    - name: Validate CMake Compiler and Toolchain
      run: |
        $cachePath = "build/CMakeCache.txt"
        if (-not (Test-Path $cachePath)) {
          Write-Error "CMake cache not found at '$cachePath'. Configure step likely failed."
          exit 1
        }

        $compilerLine = Select-String -Path $cachePath -Pattern '^CMAKE_CXX_COMPILER:(FILEPATH|PATH|STRING|UNINITIALIZED)=' | Select-Object -First 1
        $toolchainLine = Select-String -Path $cachePath -Pattern '^CMAKE_TOOLCHAIN_FILE:(FILEPATH|PATH|STRING|UNINITIALIZED)=' | Select-Object -First 1
        $compiler = $null

        if ($compilerLine) {
          $compiler = $compilerLine.Line.Split('=', 2)[1]
        } else {
          $compilerConfig = Get-ChildItem -Path "build/CMakeFiles" -Filter "CMakeCXXCompiler.cmake" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($compilerConfig) {
            $compilerSetLine = Select-String -Path $compilerConfig.FullName -Pattern '^set\(CMAKE_CXX_COMPILER \"(.+?)\"\)$' | Select-Object -First 1
            if ($compilerSetLine) {
              $compiler = $compilerSetLine.Matches[0].Groups[1].Value
            }
          }
        }

        if (-not $compiler) {
          Write-Error "CMAKE_CXX_COMPILER was not found in '$cachePath' or in CMakeCXXCompiler.cmake."
          exit 1
        }
        if (-not $toolchainLine) {
          Write-Error "CMAKE_TOOLCHAIN_FILE was not found in '$cachePath'."
          exit 1
        }
        $toolchain = $toolchainLine.Line.Split('=', 2)[1]

        Write-Host "Resolved CMAKE_CXX_COMPILER: $compiler"
        Write-Host "Resolved CMAKE_TOOLCHAIN_FILE: $toolchain"

        if ($compiler -notmatch '(?i)(^|[\\/])cl\.exe$') {
          Write-Error "Expected MSVC compiler (cl.exe), got '$compiler'."
          exit 1
        }

        if ($toolchain -notmatch '(?i)vcpkg\.cmake$') {
          Write-Error "Expected vcpkg toolchain file ending in 'vcpkg.cmake', got '$toolchain'."
          exit 1
        }

        Write-Host "Compiler and toolchain validation passed."

    # =========================================================================
    # Build Project
    # =========================================================================
    - name: Build ExoSend
      shell: cmd
      run: |
        call "%VSDEVCMD%" -no_logo -arch=x64 -host_arch=x64
        cmake --build build --config %BUILD_CONFIGURATION% --parallel

    # =========================================================================
    # Run Unit Tests
    # =========================================================================
    - name: Run Unit Tests
      run: |
        ctest --test-dir build -C ${{ env.BUILD_CONFIGURATION }} --verbose --output-on-failure --no-tests=error

    # =========================================================================
    # Validate runtime deployment completeness
    # =========================================================================
    - name: Validate runtime files
      run: |
        $ErrorActionPreference = 'Stop'

        $buildDir = "build/bin/${{ env.BUILD_CONFIGURATION }}"
        $required = @(
          (Join-Path $buildDir "ExoSend.exe"),
          (Join-Path $buildDir "ExoSendFirewallHelper.exe"),
          (Join-Path $buildDir "ExoSendReset.exe"),
          (Join-Path $buildDir "ExoSendRelaunch.exe"),
          (Join-Path $buildDir "Qt6Core.dll"),
          (Join-Path $buildDir "Qt6Gui.dll"),
          (Join-Path $buildDir "Qt6Widgets.dll"),
          (Join-Path $buildDir "libcrypto-3-x64.dll"),
          (Join-Path $buildDir "libssl-3-x64.dll"),
          (Join-Path $buildDir "platforms\\qwindows.dll"),
          (Join-Path $buildDir "styles\\qmodernwindowsstyle.dll")
        )

        $missing = $required | Where-Object { -not (Test-Path $_) }
        if ($missing.Count -gt 0) {
          $missing | ForEach-Object { Write-Host "Missing required runtime file: $_" }
          throw "Deployment completeness check failed."
        }

        # Soft check: windeployqt deploys ICU DLLs; version suffix varies per Qt release
        $icuCount = (Get-ChildItem -Path $buildDir -Filter "icu*.dll" -ErrorAction SilentlyContinue).Count
        if ($icuCount -lt 3) {
          Write-Warning "Expected >= 3 ICU DLLs from windeployqt, found: $icuCount."
        }
        Write-Host "Runtime deployment check passed."

    # =========================================================================
    # Package Release ZIP (CI artifact)
    # =========================================================================
    - name: Package ExoSend.zip
      run: |
        $ErrorActionPreference = 'Stop'

        $buildDir = "build/bin/${{ env.BUILD_CONFIGURATION }}"
        $distDir = "dist"
        $stageDir = Join-Path $distDir "ExoSend"
        $zipPath = Join-Path $distDir "ExoSend.zip"

        Remove-Item -Recurse -Force $stageDir -ErrorAction SilentlyContinue
        New-Item -ItemType Directory -Path $stageDir -Force | Out-Null

        Copy-Item (Join-Path $buildDir "ExoSend.exe") $stageDir -Force
        Copy-Item (Join-Path $buildDir "ExoSendFirewallHelper.exe") $stageDir -Force
        Copy-Item (Join-Path $buildDir "ExoSendReset.exe") $stageDir -Force
        Copy-Item (Join-Path $buildDir "ExoSendRelaunch.exe") $stageDir -Force
        Copy-Item (Join-Path $buildDir "*.dll") $stageDir -Force
        Copy-Item (Join-Path $buildDir "platforms") $stageDir -Recurse -Force
        Copy-Item (Join-Path $buildDir "styles") $stageDir -Recurse -Force

        Remove-Item $zipPath -Force -ErrorAction SilentlyContinue
        Compress-Archive -Path (Join-Path $stageDir "*") -DestinationPath $zipPath -Force

        if (-not (Test-Path $zipPath)) {
          throw "ZIP not created at '$zipPath'."
        }
        Write-Host "Created: $zipPath"

    # =========================================================================
    # Upload Build Artifacts
    # =========================================================================
    - name: Upload ExoSend.zip
      uses: actions/upload-artifact@v4
      with:
        name: ExoSend.zip
        path: dist/ExoSend.zip
        retention-days: 30

    # =========================================================================
    # Test Summary
    # =========================================================================
    - name: Test Summary
      if: always()
      run: |
        Write-Host "============================================================"
        Write-Host "Build Summary"
        Write-Host "============================================================"
        Write-Host "Configuration: ${{ env.BUILD_CONFIGURATION }}"
        Write-Host "Platform: ${{ runner.os }}"
        Write-Host "Compiler: MSVC"
        Write-Host ""
        Write-Host "Artifacts:"
        Write-Host "  - ExoSend.zip"
        Write-Host "============================================================"

    # =========================================================================
    # Cleanup Temporary NuGet Config
    # =========================================================================
    - name: Cleanup temporary NuGet config
      if: always()
      run: |
        $ErrorActionPreference = 'Continue'
        if (-not [string]::IsNullOrWhiteSpace($env:VCPKG_NUGET_CONFIG_PATH) -and (Test-Path $env:VCPKG_NUGET_CONFIG_PATH)) {
          Remove-Item -Path $env:VCPKG_NUGET_CONFIG_PATH -Force -ErrorAction Stop
          Write-Host "Temporary NuGet config removed."
        } else {
          Write-Host "No temporary NuGet config to remove."
        }
